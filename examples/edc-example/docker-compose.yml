services:

  # This is the knowledge directory, facilitating discovery between different
  # runtimes. It exposes its service over port 8282.
  knowledge-directory:
    image: ghcr.io/tno/knowledge-engine/knowledge-directory:1.3.3-SNAPSHOT
    networks:
      - tke-edc-manager_default

  # These services are seperate Knowledge Engine runtime, which can host
  # multiple smart connectors. Note that the REST API port is a DIFFERENT port
  # number than the ones configured below. It is still the default 8280.
  runtime-1:
    image: docker.io/library/ghcr.io/tno/knowledge-engine/smart-connector:1.3.3-SNAPSHOT
    networks:
      - tke-edc-manager_default
    environment:
      KE_RUNTIME_PORT: 8081 # The port that the KE uses to listen for inter-KE-runtime communication.
      KE_RUNTIME_EXPOSED_URL: http://runtime-1:8081 # The URL where the runtime is available for inter-runtime communication from the outside.
      KD_URL: http://knowledge-directory:8282
      JAVA_TOOL_OPTIONS: "-Dorg.slf4j.simpleLogger.defaultLogLevel=info"
      KE_RUNTIME_USE_EDC: true
      KE_EDC_PROTOCOL_URL: "http://one:19194/protocol"
      KE_EDC_MANAGEMENT_URL: "http://one:19193/management"
      KE_EDC_DATAPLANE_CONTROL_URL: "http://one:19192/control/transfer"
      KE_EDC_DATAPLANE_PUBLIC_URL: "http://one:19191/public"
      KE_EDC_TOKEN_VALIDATION_ENDPOINT: "http://one:19192/control/token"
    depends_on:
      - tke-edc-one
  runtime-2:
    image: docker.io/library/ghcr.io/tno/knowledge-engine/smart-connector:1.3.3-SNAPSHOT
    networks:
      - tke-edc-manager_default
    environment:
      KE_RUNTIME_PORT: 8081
      KE_RUNTIME_EXPOSED_URL: http://runtime-2:8081
      KD_URL: http://knowledge-directory:8282
      JAVA_TOOL_OPTIONS: "-Dorg.slf4j.simpleLogger.defaultLogLevel=info"
      KE_RUNTIME_USE_EDC: true
      KE_EDC_PROTOCOL_URL: "http://two:29194/protocol"
      KE_EDC_MANAGEMENT_URL: "http://two:29193/management"
      KE_EDC_DATAPLANE_CONTROL_URL: "http://two:29192/control/transfer"
      KE_EDC_DATAPLANE_PUBLIC_URL: "http://two:29191/public"
      KE_EDC_TOKEN_VALIDATION_ENDPOINT: "http://two:29192/control/token"
    depends_on:
      - tke-edc-two
  runtime-3:
    image: docker.io/library/ghcr.io/tno/knowledge-engine/smart-connector:1.3.3-SNAPSHOT
    networks:
      - tke-edc-manager_default
    environment:
      KE_RUNTIME_PORT: 8081
      KE_RUNTIME_EXPOSED_URL: http://runtime-3:8081
      KD_URL: http://knowledge-directory:8282
      JAVA_TOOL_OPTIONS: "-Dorg.slf4j.simpleLogger.defaultLogLevel=info"
      KE_RUNTIME_USE_EDC: true
      KE_EDC_PROTOCOL_URL: "http://three:39194/protocol"
      KE_EDC_MANAGEMENT_URL: "http://three:39193/management"
      KE_EDC_DATAPLANE_CONTROL_URL: "http://three:39192/control/transfer"
      KE_EDC_DATAPLANE_PUBLIC_URL: "http://three:39191/public"
      KE_EDC_TOKEN_VALIDATION_ENDPOINT: "http://three:39192/control/token"
    depends_on:
      - tke-edc-three
  tke-edc-one:
    image: openjdk:17
    entrypoint: ["/bin/sh","-c"]
    hostname: one
    networks:
      - tke-edc-manager_default
    ports:
      - "19191:19191"
      - "19192:19192"
      - "19193:19193"
      - "19194:19194"
    command:
      - |
        java -Dedc.keystore=/edc/certs/cert.pfx -Dedc.keystore.password=123456 -Dedc.vault=/edc/configuration/provider-vault.properties -Dedc.fs.config=/edc/configuration/provider-configuration.properties -jar /edc/libs/connector.jar
    volumes:
      - ./connector/certs:/edc/certs
      - ./connector/libs:/edc/libs
      - ./connector/configuration:/edc/configuration
    extra_hosts:
      - "host.docker.internal:host-gateway"
  tke-edc-two:
    image: openjdk:17
    entrypoint: [ "/bin/sh","-c" ]
    hostname: two
    networks:
      - tke-edc-manager_default
    ports:
      - "29191:29191"
      - "29192:29192"
      - "29193:29193"
      - "29194:29194"
    command:
      - |
        java -Dedc.keystore=/edc/certs/cert.pfx -Dedc.keystore.password=123456 -Dedc.vault=/edc/configuration/consumer-vault.properties -Dedc.fs.config=/edc/configuration/consumer-configuration.properties -jar /edc/libs/connector.jar
    volumes:
      - ./connector/certs:/edc/certs
      - ./connector/libs:/edc/libs
      - ./connector/configuration:/edc/configuration
    extra_hosts:
      - "host.docker.internal:host-gateway"
  tke-edc-three:
    image: openjdk:17
    entrypoint: [ "/bin/sh","-c" ]
    hostname: three
    networks:
      - tke-edc-manager_default
    ports:
      - "39191:39191"
      - "39192:39192"
      - "39193:39193"
      - "39194:39194"
    command:
      - |
        java -Dedc.keystore=/edc/certs/cert.pfx -Dedc.keystore.password=123456 -Dedc.vault=/edc/configuration/three-vault.properties -Dedc.fs.config=/edc/configuration/three-configuration.properties -jar /edc/libs/connector.jar
    volumes:
      - ./connector/certs:/edc/certs
      - ./connector/libs:/edc/libs
      - ./connector/configuration:/edc/configuration
    extra_hosts:
      - "host.docker.internal:host-gateway"
  # These Knowledge Bases use the different runtimes, and exchange data with eachother.
  kb1: # linked to edc consumer
    build: ../common/asking_kb
    networks:
      - tke-edc-manager_default
    environment:
      KE_URL: http://runtime-1:8280/rest
      KB_ID: http://example.org/kb1
      PREFIXES: |
        {
          "ex": "http://example.org/"
        }
      GRAPH_PATTERN: |
        ?a ex:relatedTo ?b .
  kb2: # linked to edc provider
    build: ../common/answering_kb
    networks:
      - tke-edc-manager_default
    environment:
      KE_URL: http://runtime-2:8280/rest
      KB_ID: http://example.org/kb2
      PREFIXES: |
        {
          "ex": "http://example.org/"
        }
      GRAPH_PATTERN: |
        ?a ex:relatedTo ?b .
      KB_DATA: |
        [
          {
            "a": "<http://example.org/Math>",
            "b": "<http://example.org/Science>"
          }
        ]
  kb3: # linked to edc provider
    build: ../common/answering_kb
    networks:
      - tke-edc-manager_default
    environment:
      KE_URL: http://runtime-3:8280/rest
      KB_ID: http://example.org/kb3
      PREFIXES: |
        {
          "ex": "http://example.org/"
        }
      GRAPH_PATTERN: |
        ?a ex:relatedTo ?b .
      KB_DATA: |
        [
          {
            "a": "<http://example.org/Magazines>",
            "b": "<http://example.org/Books>"
          }
        ]
networks:
  tke-edc-manager_default:
    external: false
